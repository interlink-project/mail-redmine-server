# This file is auto-generated by the Mailu configuration wizard.
# Please read the documentation before attempting any change.
# Generated for compose flavor

version: '3.3'

services:

  proxy:
    image: traefik:v2.6.6
    container_name: proxy-traefik
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "8081:8080"
      # Mail
#      - "25:25" #SMTP
#      - "465:465" #SMTP SSL
      - "587:587" #SMTP START
#      - "110:110" #POP3
#      - "995:995" #POP3 SSL
#      - "143:143" #IMAP
      - "993:993" #IMAP SSL
    volumes:
      - "./volumes/letsencrypt:/letsencrypt:rw"
      - "/var/run/docker.sock:/var/run/docker.sock"
    command:
      # Enable Docker in Traefik, so that it reads labels from Docker services
      - "--providers.docker=true"
      # Do not expose all Docker services, only the ones explicitly exposed
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      # Redirect Http to Https
      - "--entrypoints.web.http.redirections.entryPoint.to=websecure"
      - "--entrypoints.web.http.redirections.entryPoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      # Enable the access log, with HTTP requests
      - "--accesslog"
      # Enable the Traefik log, for configurations and errors
      - "--log"
      # Enable the Dashboard and API
      - "--api"
      # Enable the Dashboard and API in insecure mode for local development
      - "--api.insecure=false"
      - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.email=apps@interlink-project.eu"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"

      # httpchallenge
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"

      # staging
      # - --certificatesResolvers.letsencrypt.acme.caServer=https://acme-staging-v02.api.letsencrypt.org/directory

     # TCP-entry-points for mailu
      - "--entrypoints.smtp.address=:25"
      - "--entrypoints.smtps.address=:465"
      - "--entrypoints.submission.address=:587"
      - "--entrypoints.imap.address=:143"
      - "--entrypoints.imaps.address=:993"

    labels:
      - traefik.http.routers.http-catchall.rule=hostregexp(`{host:.+}`)
      - traefik.http.routers.http-catchall.entrypoints=web
      - traefik.http.routers.http-catchall.middlewares=redirect-to-https
      - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https

      # - traefik.http.middlewares.iframeHeaders.headers.customresponseheaders.Content-Security-Policy=frame-ancestors 'self' ${DOMAIN} *.${MAIN_DOMAIN}
      # - traefik.http.middlewares.iframeHeaders.headers.customresponseheaders.X-Frame-Options=ALLOW-FROM https://${MAIN_DOMAIN}
      # - traefik.http.middlewares.iframeHeaders.headers.customresponseheaders.Access-Control-Allow-Origin=*
      # - traefik.http.middlewares.iframeHeaders.headers.customresponseheaders.Access-Control-Allow-Methods=DELETE, POST, PUT, GET, OPTIONS
      # - traefik.http.middlewares.iframeHeaders.headers.customresponseheaders.Access-Control-Allow-Headers=Content-Type, Authorization, X-Requested-With
    networks:
      traefik-public:
        ipv4_address: 172.22.0.3

    logging:
      driver: "json-file"
      options:
        tag: "{{.ImageName}}|{{.Name}}|{{.ImageFullID}}|{{.FullID}}"

  redmine:
    image: redmine:4.2.3
    container_name: redmine
    restart: always
    env_file: redmine.env
    #    ports:
    #  - "80:3000"
    volumes:
      - "./volumes/redmine/docker/configuration.yml:/usr/src/redmine/config/configuration.yml"
      - "./volumes/redmine/files:/usr/src/redmine/files"
      - "./volumes/redmine/log:/usr/src/redmine/log"
      - "./volumes/redmine/plugins:/usr/src/redmine/plugins"
      - "./volumes/redmine/public/themes:/usr/src/redmine/public/themes"
    depends_on:
      - dbrm
      - proxy
    labels:
      - traefik.enable=true
      - traefik.docker.network=traefik-public
      - traefik.http.services.redmine.loadbalancer.server.port=3000
      - traefik.http.routers.redmine.entrypoints=websecure
      - traefik.http.routers.redmine.tls.certresolver=letsencrypt
      - traefik.http.routers.redmine.tls=true
      - traefik.http.routers.redmine.rule=Host(`redmine.interlink-project.eu`) && PathPrefix(`/`)
    networks:
      - traefik-public

  dbrm:
    image: postgres:12
    container_name: redmine-dbrm
    restart: always
    env_file: redmine.env
    volumes:
      - "./volumes/postgres/data:/var/lib/postgresql/data"
    networks:
      - traefik-public


networks:
  traefik-public:
    external: true
