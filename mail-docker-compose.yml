# This file is auto-generated by the Mailu configuration wizard.
# Please read the documentation before attempting any change.
# Generated for compose flavor

version: '3.3'

services:

  certdumper:
    restart: always
    container_name: mailu-certdumper
    image: mailu/traefik-certdumper:1.9.46
    environment:
      - DOMAIN=interlink-project.eu
      - TRAEFIK_VERSION=v2
    volumes:
      - './volumes/letsencrypt:/traefik'
      - './volumes/certs:/output'
    dns:
      - 192.168.203.254
    networks:
      - default
      - traefik-public

  # External dependencies
  redis:
    image: redis:alpine
    container_name: mailu-redis
    restart: always
    volumes:
      - "./volumes/redis:/data"
    depends_on:
      - resolver
    dns:
      - 192.168.203.254

  # Core services
  front:
    image: ${DOCKER_ORG:-mailu}/${DOCKER_PREFIX:-}nginx:${MAILU_VERSION:-1.9}
    container_name: mailu-front
    restart: always
    env_file: mailu.env
    ports:
##      - "80:80"
##      - "443:443"
      - "25:25"
#      - "465:465"
#      - "587:587"
#      - "110:110"
#      - "995:995"
#      - "143:143"
#      - "993:993"
    volumes:
      - "./volumes/certs:/certs"
      - "./volumes/overrides/nginx:/overrides:ro"
    depends_on:
      - resolver
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.services.mail.loadbalancer.server.port=80"
      - "traefik.http.routers.mail.entrypoints=websecure"
      - "traefik.http.routers.mail.tls.certresolver=letsencrypt"
      - "traefik.http.routers.mail.tls=true"
      - "traefik.http.routers.mail.rule=Host(`mail.interlink-project.eu`)"
#      #SMTP Relay
#      - "traefik.tcp.routers.mailu_smtp_relay.rule=HostSNI(`*`)"
#      - "traefik.tcp.routers.mailu_smtp_relay.entrypoints=smtp"
#      - "traefik.tcp.routers.mailu_smtp_relay.service=mailu_smtp_relay"
#      - "traefik.tcp.services.mailu_smtp_relay.loadbalancer.server.port=25"
#      # SMTPs
#      - "traefik.tcp.routers.mailu_smtp_ssl.rule=HostSNI(`*`)"
#      - "traefik.tcp.routers.mailu_smtp_ssl.entrypoints=smtps"
#      - "traefik.tcp.routers.mailu_smtp_ssl.tls.passthrough=true"
#      - "traefik.tcp.routers.mailu_smtp_ssl.service=mailu_smtp_ssl"
#      - "traefik.tcp.services.mailu_smtp_ssl.loadbalancer.server.port=465"
#      #SUBMISSION
#      - "traefik.tcp.routers.mailu_smtp.rule=HostSNI(`*`)"
#      - "traefik.tcp.routers.mailu_smtp.entrypoints=submission"
#      - "traefik.tcp.routers.mailu_smtp.service=mailu_smtp"
#      - "traefik.tcp.services.mailu_smtp.loadbalancer.server.port=587"
#      #IMAP
#      - "traefik.tcp.routers.mailu_imap.rule=HostSNI(`*`)"
#      - "traefik.tcp.routers.mailu_imap.entrypoints=imap"
#      - "traefik.tcp.routers.mailu_imap.service=mailu_imap"
#      - "traefik.tcp.services.mailu_imap.loadbalancer.server.port=143"
      #IMAPs
      - "traefik.tcp.routers.mailu_imap_ssl.rule=HostSNI(`*`)"
      - "traefik.tcp.routers.mailu_imap_ssl.entrypoints=imaps"
      - "traefik.tcp.routers.mailu_imap_ssl.tls.passthrough=true"
      - "traefik.tcp.routers.mailu_imap_ssl.service=mailu_imap_ssl"
      - "traefik.tcp.services.mailu_imap_ssl.loadbalancer.server.port=993"
    dns:
      - 192.168.203.254
    networks:
      - default
      - traefik-public
    logging:
      driver: journald
      options:
        tag: mailu-front


  resolver:
    image: ${DOCKER_ORG:-mailu}/${DOCKER_PREFIX:-}unbound:${MAILU_VERSION:-1.9}
    container_name: mailu-resolver
    env_file: mailu.env
    restart: always
    networks:
      default:
        ipv4_address: 192.168.203.254

  admin:
    image: ${DOCKER_ORG:-mailu}/${DOCKER_PREFIX:-}admin:${MAILU_VERSION:-1.9}
    container_name: mailu-admin
    restart: always
    env_file: mailu.env
    volumes:
      - "./volumes/data:/data"
      - "./volumes/dkim:/dkim"
    depends_on:
      - redis
      - resolver
    dns:
      - 192.168.203.254
    logging:
      driver: journald
      options:
        tag: mailu-front

  imap:
    image: ${DOCKER_ORG:-mailu}/${DOCKER_PREFIX:-}dovecot:${MAILU_VERSION:-1.9}
    container_name: mailu-imap
    restart: always
    env_file: mailu.env
    volumes:
      - "./volumes/mail:/mail"
      - "./volumes/overrides/dovecot:/overrides:ro"
    depends_on:
      - front
      - resolver
    dns:
      - 192.168.203.254

  smtp:
    image: ${DOCKER_ORG:-mailu}/${DOCKER_PREFIX:-}postfix:${MAILU_VERSION:-1.9}
    container_name: mailu-smtp
    restart: always
    env_file: mailu.env
    volumes:
      - "./volumes/mailqueue:/queue"
      - "./volumes/overrides/postfix:/overrides:ro"
    depends_on:
      - front
      - resolver
    dns:
      - 192.168.203.254

  antispam:
    image: ${DOCKER_ORG:-mailu}/${DOCKER_PREFIX:-}rspamd:${MAILU_VERSION:-1.9}
    container_name: mailu-antispam
    hostname: antispam
    restart: always
    env_file: mailu.env
    volumes:
      - "./volumes/filter:/var/lib/rspamd"
      - "./volumes/overrides/rspamd:/etc/rspamd/override.d:ro"
    depends_on:
      - front
      - resolver
    dns:
      - 192.168.203.254

  # Optional services
  antivirus:
    image: ${DOCKER_ORG:-mailu}/${DOCKER_PREFIX:-}clamav:${MAILU_VERSION:-1.9}
    container_name: mailu-antivirus
    restart: always
    env_file: mailu.env
    volumes:
      - "./volumes/filter:/data"
    depends_on:
      - resolver
    dns:
      - 192.168.203.254

  webdav:
    image: ${DOCKER_ORG:-mailu}/${DOCKER_PREFIX:-}radicale:${MAILU_VERSION:-1.9}
    container_name: mailu-webdav
    restart: always
    env_file: mailu.env
    volumes:
      - "./volumes/dav:/data"
    depends_on:
      - resolver
    dns:
      - 192.168.203.254

  fetchmail:
    image: ${DOCKER_ORG:-mailu}/${DOCKER_PREFIX:-}fetchmail:${MAILU_VERSION:-1.9}
    container_name: mailu-fetchmail
    restart: always
    env_file: mailu.env
    volumes:
      - "./volumes/data/fetchmail:/data"
    depends_on:
      - resolver
    dns:
      - 192.168.203.254

  # Webmail
  webmail:
    image: ${DOCKER_ORG:-mailu}/${DOCKER_PREFIX:-}rainloop:${MAILU_VERSION:-1.9}
    container_name: mailu-webmail
    restart: always
    env_file: mailu.env
    volumes:
      - "./volumes/webmail:/data"
      - "./volumes/overrides/rainloop:/overrides:ro"
    depends_on:
      - imap
      - resolver
    dns:
      - 192.168.203.254

networks:
  default:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 192.168.203.0/24
  traefik-public:
    external: true
